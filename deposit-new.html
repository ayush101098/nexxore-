<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexxore Vault - Deposit Assets</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/wallet.css">
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <script>
        // Early MetaMask detection
        window.addEventListener('load', function() {
            console.log('Page loaded');
            console.log('MetaMask detected:', typeof window.ethereum !== 'undefined');
            console.log('ethers.js loaded:', typeof ethers !== 'undefined');
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .wallet-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .wallet-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .wallet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .wallet-btn.connected {
            background: #10b981;
        }

        .connected-wallet {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 1rem;
        }

        .wallet-indicator {
            width: 10px;
            height: 10px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .disconnect-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .asset-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .asset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .asset-item:hover {
            background: #f9fafb;
            border-color: #667eea;
        }

        .asset-info {
            display: flex;
            flex-direction: column;
        }

        .asset-symbol {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
        }

        .asset-name {
            font-size: 0.875rem;
            color: #666;
        }

        .asset-balance {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .balance-amount {
            font-weight: 600;
            color: #667eea;
        }

        .deposit-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .deposit-btn:hover {
            background: #5568d3;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-with-max {
            display: flex;
            gap: 0.5rem;
        }

        .input-with-max input {
            flex: 1;
        }

        .max-btn {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #667eea;
        }

        .max-btn:hover {
            background: #e5e7eb;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .status-message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .status-message.show {
            display: block;
        }

        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .status-message.pending {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .vault-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-card {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .back-link {
            display: inline-block;
            color: white;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .back-link:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Home</a>
        
        <div class="header">
            <h1>üè¶ Nexxore Vault</h1>
            <p>Deposit your crypto assets securely</p>
        </div>

        <div class="main-grid">
            <!-- Your Assets -->
            <div class="card">
                <h2>Your Assets</h2>
                <div class="wallet-section">
                    <button class="wallet-btn" id="connectWallet">Connect Wallet</button>
                    <div id="walletInfo" style="display: none;"></div>
                </div>
                <div id="assetList">
                    <p style="text-align: center; color: #888;">Connect wallet to view your assets</p>
                </div>
            </div>

            <!-- Deposit Form -->
            <div class="card">
                <h2>Deposit Assets</h2>
                <div id="statusMessage" class="status-message"></div>
                
                <form id="depositForm">
                    <div class="form-group">
                        <label for="tokenSelect">Select Asset</label>
                        <select id="tokenSelect" required>
                            <option value="">Choose an asset...</option>
                            <option value="ETH">ETH - Ethereum</option>
                            <option value="USDT">USDT - Tether USD</option>
                            <option value="USDC">USDC - USD Coin</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="amount">Amount</label>
                        <div class="input-with-max">
                            <input 
                                type="number" 
                                id="amount" 
                                placeholder="0.0" 
                                step="any"
                                min="0"
                                required
                            >
                            <button type="button" class="max-btn" id="maxBtn">MAX</button>
                        </div>
                    </div>

                    <button type="submit" class="submit-btn" id="depositBtn">
                        Deposit to Vault
                    </button>
                </form>

                <div class="vault-stats">
                    <div class="stat-card">
                        <div class="stat-label">Your Deposits</div>
                        <div class="stat-value" id="userDeposits">0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Vault</div>
                        <div class="stat-value" id="totalVault">0.00</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/wallet.js"></script>
    <script>
        const VAULT_ADDRESS = '0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512';
        const USDT_ADDRESS = '0xdAC17F958D2ee523a2206206994597C13D831ec7';
        const USDC_ADDRESS = '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48';

        const VAULT_ABI = [
            'function depositToken(address token, uint256 amount) external',
            'function depositETH() external payable',
            'function getUserBalance(address user, address token) external view returns (uint256)',
            'function getTotalDeposits(address token) external view returns (uint256)',
            'event TokenDeposit(address indexed user, address indexed token, uint256 amount, uint256 timestamp)',
            'event ETHDeposit(address indexed user, uint256 amount, uint256 timestamp)'
        ];

        const ERC20_ABI = [
            'function approve(address spender, uint256 amount) external returns (bool)',
            'function allowance(address owner, address spender) external view returns (uint256)',
            'function balanceOf(address account) external view returns (uint256)'
        ];

        let vaultContract = null;

        // Show status message
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message show ${type}`;
            
            if (type !== 'pending') {
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 5000);
            }
        }

        // Set max amount
        document.getElementById('maxBtn').addEventListener('click', function() {
            const tokenSelect = document.getElementById('tokenSelect');
            const amountInput = document.getElementById('amount');
            const selectedToken = tokenSelect.value;

            const asset = window.walletConnector.getAssets().find(a => a.symbol === selectedToken);
            if (asset) {
                amountInput.value = asset.balance;
            }
        });

        // Handle deposit form
        document.getElementById('depositForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const signer = window.walletConnector.getSigner();
            const address = window.walletConnector.getAddress();

            if (!signer || !address) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            const tokenSelect = document.getElementById('tokenSelect');
            const amountInput = document.getElementById('amount');
            const token = tokenSelect.value;
            const amount = amountInput.value;

            if (!token || !amount || parseFloat(amount) <= 0) {
                showStatus('Please select a token and enter a valid amount', 'error');
                return;
            }

            try {
                showStatus('Processing deposit...', 'pending');

                if (!vaultContract) {
                    vaultContract = new ethers.Contract(VAULT_ADDRESS, VAULT_ABI, signer);
                }

                if (token === 'ETH') {
                    // Deposit ETH
                    const tx = await vaultContract.depositETH({
                        value: ethers.utils.parseEther(amount)
                    });
                    showStatus('Transaction sent! Waiting for confirmation...', 'pending');
                    await tx.wait();
                    showStatus('ETH deposited successfully!', 'success');
                } else {
                    // Deposit ERC20
                    const tokenAddress = token === 'USDT' ? USDT_ADDRESS : USDC_ADDRESS;
                    const decimals = token === 'USDT' || token === 'USDC' ? 6 : 18;
                    const tokenAmount = ethers.utils.parseUnits(amount, decimals);

                    const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, signer);

                    // Check allowance
                    showStatus('Checking token approval...', 'pending');
                    const allowance = await tokenContract.allowance(address, VAULT_ADDRESS);

                    if (allowance.lt(tokenAmount)) {
                        showStatus('Approving token...', 'pending');
                        const approveTx = await tokenContract.approve(VAULT_ADDRESS, ethers.constants.MaxUint256);
                        await approveTx.wait();
                    }

                    // Deposit
                    showStatus('Depositing tokens...', 'pending');
                    const depositTx = await vaultContract.depositToken(tokenAddress, tokenAmount);
                    await depositTx.wait();
                    showStatus(`${token} deposited successfully!`, 'success');
                }

                // Reset form and reload assets
                amountInput.value = '';
                await loadUserAssets();
                await loadVaultStats();

            } catch (error) {
                console.error('Deposit error:', error);
                showStatus('Deposit failed: ' + (error.message || 'Unknown error'), 'error');
            }
        });

        // Load vault stats
        async function loadVaultStats() {
            const address = window.walletConnector.getAddress();
            const provider = window.walletConnector.getProvider();
            
            if (!provider || !address) return;

            try {
                const vault = new ethers.Contract(VAULT_ADDRESS, VAULT_ABI, provider);
                const balance = await vault.getUserBalance(address, ethers.constants.AddressZero);
                const total = await vault.getTotalDeposits(ethers.constants.AddressZero);

                document.getElementById('userDeposits').textContent = 
                    parseFloat(ethers.utils.formatEther(balance)).toFixed(4) + ' ETH';
                document.getElementById('totalVault').textContent = 
                    parseFloat(ethers.utils.formatEther(total)).toFixed(4) + ' ETH';
            } catch (error) {
                console.error('Error loading vault stats:', error);
            }
        }

        // Override loadUserAssets to also load vault stats
        const originalLoadAssets = window.loadUserAssets;
        window.loadUserAssets = async function() {
            await originalLoadAssets();
            await loadVaultStats();
        };
    </script>
</body>
</html>
