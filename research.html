<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Info Edge - Research Intelligence | nexxore</title>
  <meta name="description" content="Real-time crypto research, sentiment analysis, and alpha signals powered by autonomous agents.">
  
  <!-- Google Fonts: Space Grotesk, Inter, JetBrains Mono -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Web3 Libraries -->
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
  
  <style>
    :root {
      --font-heading: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-body: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --bg-primary: #0A0E27;
      --bg-secondary: #0F172A;
      --accent-cyan: #0EA5E9;
      --accent-purple: #8B5CF6;
      --text-primary: #F8FAFC;
      --text-secondary: #CBD5E1;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-body);
      background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-secondary);
      min-height: 100vh;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 32px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .header-right {
      display: flex;
      align-items: center;
    }

    .btn {
      cursor: pointer;
      font-family: inherit;
    }

    .btn-primary {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #00d4ff, #0099ff);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 212, 255, 0.3);
    }

    .btn-primary.connected {
      background: linear-gradient(135deg, #22c55e, #16a34a);
    }

    .back-link {
      color: #00d4ff;
      text-decoration: none;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: opacity 0.3s;
    }

    .back-link:hover {
      opacity: 0.7;
    }

    .header-title {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #00d4ff, #0099ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-subtitle {
      display: none;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #22c55e;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 1.5fr 1fr;
      gap: 20px;
      padding: 24px 32px;
      max-width: 1800px;
      margin: 0 auto;
      height: calc(100vh - 90px);
    }

    .panel {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .panel-title {
      font-size: 1rem;
      font-weight: 600;
      color: #00d4ff;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .panel-badge {
      font-size: 0.75rem;
      padding: 4px 10px;
      background: rgba(0, 212, 255, 0.15);
      border-radius: 12px;
      color: #00d4ff;
    }

    /* News Panel */
    .news-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .news-list::-webkit-scrollbar {
      width: 6px;
    }

    .news-list::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .news-list::-webkit-scrollbar-thumb {
      background: rgba(0, 212, 255, 0.3);
      border-radius: 10px;
    }

    .news-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 14px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s;
      cursor: pointer;
    }

    .news-item:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(0, 212, 255, 0.3);
      transform: translateX(4px);
    }

    .news-source {
      font-size: 0.75rem;
      color: #00d4ff;
      font-weight: 600;
      margin-bottom: 6px;
      text-transform: uppercase;
    }

    .news-title {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 8px;
      line-height: 1.4;
      color: #f3f4f6;
    }

    .news-sentiment {
      display: inline-block;
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 6px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .sentiment-bullish {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .sentiment-bearish {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .sentiment-neutral {
      background: rgba(156, 163, 175, 0.2);
      color: #9ca3af;
    }

    /* Chat Panel */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
      padding-right: 8px;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: rgba(0, 212, 255, 0.3);
      border-radius: 10px;
    }

    .message {
      padding: 12px 16px;
      border-radius: 12px;
      max-width: 85%;
      line-height: 1.5;
      font-size: 0.9rem;
    }

    .message.user {
      background: rgba(0, 212, 255, 0.15);
      border: 1px solid rgba(0, 212, 255, 0.3);
      align-self: flex-end;
      margin-left: auto;
    }

    .message.ai {
      background: rgba(147, 51, 234, 0.15);
      border: 1px solid rgba(147, 51, 234, 0.3);
      align-self: flex-start;
    }

    .message.ai strong {
      color: #c084fc;
    }

    .chat-input-container {
      display: flex;
      gap: 10px;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: #fff;
      font-size: 0.9rem;
      font-family: 'Inter', sans-serif;
    }

    .chat-input:focus {
      outline: none;
      border-color: rgba(0, 212, 255, 0.5);
      background: rgba(255, 255, 255, 0.08);
    }

    .chat-send {
      padding: 12px 24px;
      background: linear-gradient(135deg, #00d4ff, #0099ff);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .chat-send:hover {
      transform: scale(1.05);
    }

    .chat-send:active {
      transform: scale(0.98);
    }

    /* Trending Panel */
    .trending-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .trending-list::-webkit-scrollbar {
      width: 6px;
    }

    .trending-list::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .trending-list::-webkit-scrollbar-thumb {
      background: rgba(0, 212, 255, 0.3);
      border-radius: 10px;
    }

    .trending-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s;
    }

    .trending-item:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(0, 212, 255, 0.3);
    }

    .trending-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .trending-symbol {
      font-size: 0.95rem;
      font-weight: 700;
      color: #00d4ff;
    }

    .trending-rank {
      font-size: 0.75rem;
      color: #9ca3af;
      background: rgba(255, 255, 255, 0.05);
      padding: 2px 8px;
      border-radius: 6px;
    }

    .trending-name {
      font-size: 0.8rem;
      color: #d1d5db;
      margin-bottom: 8px;
    }

    .trending-stats {
      display: flex;
      gap: 12px;
      font-size: 0.75rem;
    }

    .stat-item {
      color: #9ca3af;
    }

    .stat-value {
      color: #f3f4f6;
      font-weight: 600;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #9ca3af;
      font-size: 0.9rem;
    }

    .error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      padding: 12px;
      border-radius: 10px;
      margin: 10px 0;
      font-size: 0.85rem;
    }

    /* Alpha Scanner Styles */
    .scanner-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .scanner-controls {
      display: flex;
      gap: 8px;
    }

    .scanner-btn {
      padding: 8px 14px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      color: #9ca3af;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .scanner-btn:hover {
      background: rgba(0, 212, 255, 0.1);
      border-color: rgba(0, 212, 255, 0.3);
      color: #00d4ff;
    }

    .scanner-btn.active {
      background: rgba(0, 212, 255, 0.15);
      border-color: #00d4ff;
      color: #00d4ff;
    }

    .signal-card {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 14px;
      padding: 18px;
      margin-bottom: 14px;
      transition: all 0.3s;
    }

    .signal-card:hover {
      background: rgba(255, 255, 255, 0.04);
      border-color: rgba(0, 212, 255, 0.25);
      transform: translateX(4px);
    }

    .signal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .signal-type-badge {
      font-size: 0.7rem;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .signal-type-badge.oi_divergence {
      background: rgba(139, 92, 246, 0.2);
      color: #a78bfa;
    }

    .signal-type-badge.tvl_lag {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .signal-type-badge.funding_divergence {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    .signal-asset {
      font-family: var(--font-heading);
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .confidence-meter {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .confidence-bar {
      width: 60px;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
    }

    .confidence-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .confidence-fill.high { background: linear-gradient(90deg, #22c55e, #4ade80); }
    .confidence-fill.medium { background: linear-gradient(90deg, #fbbf24, #fcd34d); }
    .confidence-fill.low { background: linear-gradient(90deg, #9ca3af, #d1d5db); }

    .confidence-score {
      font-family: var(--font-mono);
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .signal-context {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 14px;
      padding: 10px 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      border-left: 3px solid rgba(0, 212, 255, 0.5);
    }

    .signal-section {
      margin-bottom: 12px;
    }

    .signal-section-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: #00d4ff;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .signal-section-content {
      font-size: 0.85rem;
      color: #d1d5db;
      line-height: 1.5;
    }

    .trade-expression {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }

    .trade-expression .signal-section-title {
      color: #22c55e;
    }

    .trade-expression .signal-section-content {
      font-family: var(--font-mono);
      color: #4ade80;
      font-weight: 500;
    }

    .signal-meta {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .meta-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .meta-label {
      font-size: 0.7rem;
      color: #64748b;
      text-transform: uppercase;
    }

    .meta-value {
      font-size: 0.8rem;
      color: #94a3b8;
    }

    .meta-value.risk { color: #f87171; }
    .meta-value.invalidation { color: #fbbf24; }

    .signal-expand-btn {
      width: 100%;
      padding: 8px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      color: #64748b;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 10px;
    }

    .signal-expand-btn:hover {
      background: rgba(0, 212, 255, 0.05);
      color: #00d4ff;
    }

    .signal-details {
      display: none;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed rgba(255, 255, 255, 0.1);
    }

    .signal-details.expanded {
      display: block;
    }

    .no-signals {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }

    .no-signals-icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    @media (max-width: 1400px) {
      .container {
        grid-template-columns: 1fr 1fr;
      }
      .panel.full-width {
        grid-column: 1 / -1;
      }
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
      .header {
        padding: 16px;
      }
      .signal-meta {
        grid-template-columns: 1fr;
      }
    }

    /* Insights specific styles */
    .insights-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .insight-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 14px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s;
    }

    .insight-item:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(0, 212, 255, 0.3);
    }

    .insight-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .insight-protocol {
      font-size: 1rem;
      font-weight: 700;
      color: #00d4ff;
      text-transform: uppercase;
    }

    .insight-confidence {
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 600;
    }

    .confidence-high {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .confidence-medium {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    .confidence-low {
      background: rgba(156, 163, 175, 0.2);
      color: #9ca3af;
    }

    .insight-summary {
      font-size: 0.85rem;
      color: #d1d5db;
      margin-bottom: 10px;
      line-height: 1.5;
    }

    .insight-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      font-size: 0.75rem;
    }

    .metric-item {
      background: rgba(255, 255, 255, 0.02);
      padding: 6px 10px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
    }

    .metric-label {
      color: #9ca3af;
    }

    .metric-value {
      color: #f3f4f6;
      font-weight: 600;
    }

    .metric-value.positive {
      color: #22c55e;
    }

    .metric-value.negative {
      color: #ef4444;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <div>
        <span class="header-title">Info Edge</span>
        <span class="header-subtitle">Research Intelligence Dashboard</span>
      </div>
    </div>
    <div class="header-right">
      <div id="portfolioHealth" style="display: none; margin-right: 20px; padding: 8px 16px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; font-size: 0.9rem;">
        <span style="color: #9ca3af;">Health Score:</span>
        <span id="healthScore" style="color: #22c55e; font-weight: 600; margin-left: 8px;">--</span>
      </div>
      <button id="connectWalletBtn" class="btn btn-primary" style="padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #00d4ff, #0099ff); color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">
        Connect Wallet
      </button>
    </div>
  </div>

  <div class="container">
    <!-- Alpha Scanner Panel - Full Width -->
    <div class="panel full-width" style="grid-column: 1 / -1;">
      <div class="panel-header">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="panel-title">üéØ Alpha Scanner</div>
          <div class="panel-badge" id="signalCount">0</div>
        </div>
        <div class="scanner-controls">
          <button class="scanner-btn active" data-type="all" onclick="filterSignals('all')">All</button>
          <button class="scanner-btn" data-type="oi_divergence" onclick="filterSignals('oi_divergence')">OI Divergence</button>
          <button class="scanner-btn" data-type="tvl_lag" onclick="filterSignals('tvl_lag')">TVL Lag</button>
          <button class="scanner-btn" data-type="funding_divergence" onclick="filterSignals('funding_divergence')">Funding</button>
          <button class="scanner-btn" onclick="runAlphaScan(true)" style="background: rgba(0, 212, 255, 0.1); border-color: rgba(0, 212, 255, 0.3);">‚Üª Refresh</button>
        </div>
      </div>
      <div id="alphaSignals" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 16px; max-height: 500px; overflow-y: auto;">
        <div class="loading">Scanning for alpha signals...</div>
      </div>
    </div>

    <!-- Research Insights Panel -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">üìä Protocol Insights</div>
        <div class="panel-badge" id="insightsCount">0</div>
      </div>
      <div class="insights-list" id="insightsList">
        <div class="loading">Analyzing protocols...</div>
      </div>
    </div>

    <!-- News Panel -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">üì∞ Latest News</div>
        <div class="panel-badge" id="newsCount">0</div>
      </div>
      <div class="news-list" id="newsList">
        <div class="loading">Loading news...</div>
      </div>
    </div>

    <!-- Trending Panel -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">üî• Trending</div>
        <div class="panel-badge" id="trendingCount">0</div>
      </div>
      <div class="trending-list" id="trendingList">
        <div class="loading">Loading trending tokens...</div>
      </div>
    </div>

    <!-- Chat Panel - Full Width -->
    <div class="panel full-width">
      <div class="panel-header">
        <div class="panel-title">üí¨ AI Research Assistant</div>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="message ai">
          <strong>Info Edge:</strong> Hello! I'm your research agent. Ask me about crypto trends, tokens, or market sentiment. I have access to real-time news and data.
        </div>
      </div>
      <div class="chat-input-container">
        <input type="text" class="chat-input" id="chatInput" placeholder="Ask about crypto trends, sentiment, or specific tokens..." />
        <button class="chat-send" id="chatSend">Send</button>
      </div>
    </div>
  </div>

  <script>
    // Use relative path for API in production, localhost in development
    const API_BASE = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000/api' 
      : '/api';
    
    console.log('üöÄ Research Dashboard Initialized');
    console.log('üì° API Base URL:', API_BASE);

    // Fetch and display research insights
    async function loadInsights() {
      console.log('üéØ Loading research insights...');
      try {
        const response = await fetch(`${API_BASE}/research/insights?protocols=aave,curve,uniswap,compound`);
        console.log('üì• Insights response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Insights data loaded:', data);
        
        const insightsList = document.getElementById('insightsList');
        const insightsCount = document.getElementById('insightsCount');
        
        if (data.error) {
          insightsList.innerHTML = `<div class="error">${data.error}</div>`;
          console.error('‚ùå API returned error:', data.error);
        } else if (data.insights && data.insights.length > 0) {
          insightsCount.textContent = data.insights.length;
          insightsList.innerHTML = data.insights.map(insight => {
            const confidenceClass = insight.confidence >= 0.6 ? 'high' : 
                                   insight.confidence >= 0.3 ? 'medium' : 'low';
            const confidenceLabel = insight.confidence >= 0.6 ? 'High' : 
                                   insight.confidence >= 0.3 ? 'Medium' : 'Low';
            
            return `
              <div class="insight-item">
                <div class="insight-header">
                  <div class="insight-protocol">${insight.protocol}</div>
                  <div class="insight-confidence confidence-${confidenceClass}">
                    ${confidenceLabel} ${(insight.confidence * 100).toFixed(0)}%
                  </div>
                </div>
                <div class="insight-summary">${insight.summary || 'No summary available'}</div>
                <div class="insight-metrics">
                  ${insight.signals && insight.signals.defi && insight.signals.defi.length > 0 ? `
                    <div class="metric-item">
                      <span class="metric-label">TVL</span>
                      <span class="metric-value">$${(insight.signals.defi[0].tvl / 1e9).toFixed(2)}B</span>
                    </div>
                    <div class="metric-item">
                      <span class="metric-label">7d Change</span>
                      <span class="metric-value ${insight.signals.defi[0].tvlChange7d >= 0 ? 'positive' : 'negative'}">
                        ${insight.signals.defi[0].tvlChange7d >= 0 ? '+' : ''}${insight.signals.defi[0].tvlChange7d.toFixed(2)}%
                      </span>
                    </div>
                  ` : `
                    <div class="metric-item">
                      <span class="metric-label">Status</span>
                      <span class="metric-value">Analyzing...</span>
                    </div>
                  `}
                  <div class="metric-item">
                    <span class="metric-label">Signals</span>
                    <span class="metric-value">${Object.values(insight.signals || {}).flat().length}</span>
                  </div>
                  <div class="metric-item">
                    <span class="metric-label">Insights</span>
                    <span class="metric-value">${insight.insights?.length || 0}</span>
                  </div>
                </div>
              </div>
            `;
          }).join('');
          console.log('‚úÖ Insights rendered:', data.insights.length, 'items');
        } else {
          insightsList.innerHTML = '<div class="error">No insights available</div>';
          console.warn('‚ö†Ô∏è No insights data found');
        }
      } catch (error) {
        console.error('‚ùå Error loading insights:', error);
        document.getElementById('insightsList').innerHTML = `<div class="error">Failed to load insights: ${error.message}</div>`;
      }
    }

    // Fetch and display news
    async function loadNews() {
      console.log('üì∞ Loading news...');
      try {
        const response = await fetch(`${API_BASE}/news`);
        console.log('üì• News response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ News data loaded:', data);
        
        const newsList = document.getElementById('newsList');
        const newsCount = document.getElementById('newsCount');
        
        if (data.error) {
          newsList.innerHTML = `<div class="error">${data.error}</div>`;
          console.error('‚ùå API returned error:', data.error);
        } else if (data.news && data.news.length > 0) {
          newsCount.textContent = data.news.length;
          newsList.innerHTML = data.news.map(item => `
            <div class="news-item" onclick="window.open('${item.url}', '_blank')">
              <div class="news-source">${item.source}</div>
              <div class="news-title">${item.title}</div>
              <span class="news-sentiment sentiment-${item.sentiment || 'neutral'}">${item.sentiment || 'neutral'}</span>
            </div>
          `).join('');
          console.log('‚úÖ News rendered:', data.news.length, 'items');
        } else {
          newsList.innerHTML = '<div class="error">No news available</div>';
          console.warn('‚ö†Ô∏è No news data found');
        }
      } catch (error) {
        console.error('‚ùå Error loading news:', error);
        document.getElementById('newsList').innerHTML = `<div class="error">Failed to load news: ${error.message}</div>`;
      }
    }

    // Fetch and display trending tokens
    async function loadTrending() {
      console.log('üî• Loading trending tokens...');
      try {
        const response = await fetch(`${API_BASE}/trending`);
        console.log('üì• Trending response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Trending data loaded:', data);
        
        const trendingList = document.getElementById('trendingList');
        const trendingCount = document.getElementById('trendingCount');
        
        if (data.error) {
          trendingList.innerHTML = `<div class="error">${data.error}</div>`;
          console.error('‚ùå API returned error:', data.error);
        } else if (data.trending && data.trending.length > 0) {
          trendingCount.textContent = data.trending.length;
          trendingList.innerHTML = data.trending.map((token, index) => `
            <div class="trending-item">
              <div class="trending-header">
                <div class="trending-symbol">${token.symbol}</div>
                <div class="trending-rank">#${index + 1}</div>
              </div>
              <div class="trending-name">${token.name}</div>
              <div class="trending-stats">
                <div class="stat-item">Rank: <span class="stat-value">${token.market_cap_rank || 'N/A'}</span></div>
              </div>
            </div>
          `).join('');
          console.log('‚úÖ Trending rendered:', data.trending.length, 'tokens');
        } else {
          trendingList.innerHTML = '<div class="error">No trending data available</div>';
          console.warn('‚ö†Ô∏è No trending data found');
        }
      } catch (error) {
        console.error('‚ùå Error loading trending:', error);
        document.getElementById('trendingList').innerHTML = `<div class="error">Failed to load trending: ${error.message}</div>`;
      }
    }

    // Chat functionality
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const messages = document.getElementById('chatMessages');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Add user message
      const userMsg = document.createElement('div');
      userMsg.className = 'message user';
      userMsg.textContent = message;
      messages.appendChild(userMsg);
      
      input.value = '';
      messages.scrollTop = messages.scrollHeight;
      
      // Send to AI
      try {
        const response = await fetch(`${API_BASE}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        
        const data = await response.json();
        
        // Add AI response
        const aiMsg = document.createElement('div');
        aiMsg.className = 'message ai';
        aiMsg.innerHTML = `<strong>Info Edge:</strong> ${data.response}`;
        messages.appendChild(aiMsg);
        
        messages.scrollTop = messages.scrollHeight;
      } catch (error) {
        console.error('Error sending message:', error);
        const errorMsg = document.createElement('div');
        errorMsg.className = 'message ai error';
        errorMsg.innerHTML = '<strong>Error:</strong> Failed to get response';
        messages.appendChild(errorMsg);
      }
    }

    // Event listeners
    document.getElementById('chatSend').addEventListener('click', sendMessage);
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // Initial load
    loadInsights();
    loadNews();
    loadTrending();
    runAlphaScan();

    // Auto-refresh every 5 minutes
    setInterval(() => {
      loadInsights();
      loadNews();
      loadTrending();
      runAlphaScan();
    }, 5 * 60 * 1000);

    // ===============================
    // ALPHA SCANNER FUNCTIONALITY
    // ===============================
    
    let allAlphaSignals = [];
    let currentFilter = 'all';

    // Run alpha scan
    async function runAlphaScan(refresh = false) {
      console.log('üéØ Running alpha scan...');
      const container = document.getElementById('alphaSignals');
      const countBadge = document.getElementById('signalCount');
      
      container.innerHTML = '<div class="loading">Scanning markets for anomalies...</div>';
      
      try {
        // For now, use mock data since API might not be deployed
        // In production, this would call: `${API_BASE}/research/alpha-scan${refresh ? '?refresh=true' : ''}`
        const signals = await generateMockSignals();
        
        allAlphaSignals = signals;
        countBadge.textContent = signals.length;
        
        renderSignals(signals);
        console.log('‚úÖ Alpha scan complete:', signals.length, 'signals');
      } catch (error) {
        console.error('‚ùå Alpha scan failed:', error);
        container.innerHTML = `<div class="error">Scan failed: ${error.message}</div>`;
      }
    }

    // Filter signals by type
    function filterSignals(type) {
      currentFilter = type;
      
      // Update button states
      document.querySelectorAll('.scanner-btn[data-type]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });
      
      const filtered = type === 'all' 
        ? allAlphaSignals 
        : allAlphaSignals.filter(s => s.signalType.toLowerCase() === type);
      
      renderSignals(filtered);
    }

    // Render signal cards
    function renderSignals(signals) {
      const container = document.getElementById('alphaSignals');
      
      if (signals.length === 0) {
        container.innerHTML = `
          <div class="no-signals">
            <div class="no-signals-icon">üîç</div>
            <p>No actionable signals detected</p>
            <p style="font-size: 0.8rem; margin-top: 8px;">Markets appear range-bound with no significant anomalies</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = signals.map((signal, idx) => {
        const confClass = signal.confidenceScore >= 60 ? 'high' : signal.confidenceScore >= 40 ? 'medium' : 'low';
        const typeClass = signal.signalType.toLowerCase();
        
        return `
          <div class="signal-card" data-signal-id="${idx}">
            <div class="signal-header">
              <div>
                <span class="signal-type-badge ${typeClass}">${formatSignalType(signal.signalType)}</span>
                <div class="signal-asset" style="margin-top: 6px;">${signal.asset}</div>
              </div>
              <div class="confidence-meter">
                <div class="confidence-bar">
                  <div class="confidence-fill ${confClass}" style="width: ${signal.confidenceScore}%;"></div>
                </div>
                <span class="confidence-score">${signal.confidenceScore}%</span>
              </div>
            </div>
            
            <div class="signal-context">${signal.marketContext}</div>
            
            <div class="signal-section">
              <div class="signal-section-title">Observed Anomaly</div>
              <div class="signal-section-content">${signal.observedAnomaly}</div>
            </div>
            
            <div class="trade-expression">
              <div class="signal-section-title">Trade Expression</div>
              <div class="signal-section-content">${signal.tradeExpression}</div>
            </div>
            
            <div class="signal-meta">
              <div class="meta-item">
                <span class="meta-label">Time Horizon</span>
                <span class="meta-value">${signal.timeHorizon}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Invalidation</span>
                <span class="meta-value invalidation">${signal.invalidationLevel}</span>
              </div>
            </div>
            
            <button class="signal-expand-btn" onclick="toggleSignalDetails(${idx})">
              Show full analysis ‚ñº
            </button>
            
            <div class="signal-details" id="signal-details-${idx}">
              <div class="signal-section">
                <div class="signal-section-title">Why This Matters</div>
                <div class="signal-section-content">${signal.whyMatters}</div>
              </div>
              <div class="signal-section">
                <div class="signal-section-title">Key Risks</div>
                <div class="signal-section-content meta-value risk">${signal.keyRisks}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Toggle signal details
    function toggleSignalDetails(idx) {
      const details = document.getElementById(`signal-details-${idx}`);
      const btn = details.previousElementSibling;
      
      if (details.classList.contains('expanded')) {
        details.classList.remove('expanded');
        btn.textContent = 'Show full analysis ‚ñº';
      } else {
        details.classList.add('expanded');
        btn.textContent = 'Hide analysis ‚ñ≤';
      }
    }

    // Format signal type for display
    function formatSignalType(type) {
      const types = {
        'OI_DIVERGENCE': 'OI Divergence',
        'TVL_LAG': 'TVL Lag',
        'FUNDING_DIVERGENCE': 'Funding'
      };
      return types[type] || type;
    }

    // Generate mock signals for demo (replace with API call in production)
    async function generateMockSignals() {
      // Simulate API delay
      await new Promise(r => setTimeout(r, 1500));
      
      return [
        {
          signalType: 'TVL_LAG',
          asset: 'Pendle (PENDLE)',
          marketContext: 'Pendle TVL: $4.2B. 7d TVL change: +18.4%. Token price 7d: +3.2%. TVL/MCap ratio: 6.8x.',
          observedAnomaly: 'TVL growth (+18.4%) significantly outpacing token appreciation (+3.2%). Divergence: 15.2%. TVL growth is ACCELERATING with new yield markets launching.',
          whyMatters: 'Capital is flowing into protocol but token price hasn\'t adjusted. This suggests: (1) LPs/yield farmers don\'t hold governance token, or (2) Market hasn\'t priced in growth. Protocol revenue/fees typically correlate with TVL over medium term.',
          tradeExpression: 'Long PENDLE spot. Entry: current ($5.42). Target: 12-15% catch-up move over 1-2 weeks based on TVL/price convergence.',
          timeHorizon: '1-2 weeks',
          keyRisks: 'Mercenary TVL (incentivized, will leave), token inflation diluting value, smart contract risk, broader market downturn',
          invalidationLevel: 'TVL drops >10% or price falls below $4.80',
          confidenceScore: 72
        },
        {
          signalType: 'OI_DIVERGENCE',
          asset: 'SOL',
          marketContext: 'SOL showing compressed volatility (1.8%) with elevated volume ($2.1B). Price flat over 7d (-0.8%). Volume/MCap ratio: 2.4%.',
          observedAnomaly: 'High trading activity without directional follow-through. Volume/MCap ratio: 2.4%. This typically precedes breakouts. Late shorts accumulated near support are likely offsides.',
          whyMatters: 'Position buildup during range compression often leads to liquidation cascades when price breaks. Shorts accumulated near support are likely offsides given strong ecosystem fundamentals.',
          tradeExpression: 'Long SOL on breakout above 7d high ($198.50), target 5-8% move to $210-$215',
          timeHorizon: '24-72 hours',
          keyRisks: 'False breakout, news catalyst overriding technical setup, low liquidity slippage during breakout',
          invalidationLevel: 'Below $188.00 (-2% from 7d low)',
          confidenceScore: 58
        },
        {
          signalType: 'FUNDING_DIVERGENCE',
          asset: 'ETH',
          marketContext: 'ETH at $3,420. 24h range: $3,380 - $3,465. Currently at 87% of range (near highs).',
          observedAnomaly: 'Crowded long positioning detected. High volume (3.1% of MCap) with price near highs. This often precedes mean reversion as funding costs pressure overleveraged longs.',
          whyMatters: 'When positioning gets one-sided, funding costs increase for the crowded side. This creates: (1) Pressure to close positions, (2) Arbitrage incentive for market makers, (3) Squeeze risk if price moves against crowd.',
          tradeExpression: 'Fade longs: Short ETH with tight stop above 24h high. Target: return to 24h VWAP (~$3,422)',
          timeHorizon: '4-24 hours',
          keyRisks: 'Trend continuation invalidates thesis, ETF flow news catalyst, exchange-specific dynamics',
          invalidationLevel: 'New 24h high above $3,495',
          confidenceScore: 48
        },
        {
          signalType: 'TVL_LAG',
          asset: 'Morpho (MORPHO)',
          marketContext: 'Morpho TVL: $3.8B. 7d TVL change: +12.1%. Token price 7d: -1.4%. TVL/MCap ratio: 9.2x.',
          observedAnomaly: 'TVL growth (+12.1%) while token price declining (-1.4%). Divergence: 13.5%. Capital inflows continue despite token weakness.',
          whyMatters: 'Extreme TVL/price divergence suggests mispricing. Morpho\'s optimized lending rates attracting capital, but token holders are selling. Classic accumulation opportunity if TVL growth is organic.',
          tradeExpression: 'Long MORPHO spot. Entry: current ($2.18). Target: 10% reversion to fair value based on TVL multiple.',
          timeHorizon: '1-2 weeks',
          keyRisks: 'Concentrated TVL in few wallets, token unlock schedule, regulatory risk for lending protocols',
          invalidationLevel: 'TVL drops >8% or price falls below $1.95',
          confidenceScore: 65
        }
      ];
    }
  </script>
  
  <!-- Wallet Connection Module -->
  <script src="js/walletConnect.js"></script>
  
  <script>
    // Portfolio Health Score Integration
    let userAssets = [];

    // Calculate portfolio health score
    function calculateHealthScore(assets) {
      if (!assets || assets.length === 0) return 0;

      let score = 30; // Base score
      
      const hasStables = assets.some(a => ['USDT', 'USDC', 'DAI', 'BUSD'].includes(a.symbol));
      const hasEth = assets.some(a => a.symbol === 'ETH');
      
      // Diversity bonus
      if (assets.length >= 2) score += 20;
      if (assets.length >= 3) score += 10;
      if (assets.length >= 4) score += 10;
      
      // Stablecoin presence
      if (hasStables) score += 15;
      
      // ETH presence
      if (hasEth) score += 15;

      return Math.min(100, score);
    }

    // Update portfolio health UI
    function updatePortfolioHealth() {
      const healthScore = calculateHealthScore(userAssets);
      const healthScoreEl = document.getElementById('healthScore');
      const portfolioHealthEl = document.getElementById('portfolioHealth');
      const walletState = window.WalletConnect ? window.WalletConnect.getState() : null;

      if (healthScoreEl && portfolioHealthEl && walletState) {
        healthScoreEl.textContent = healthScore + '/100';
        
        if (healthScore >= 70) {
          healthScoreEl.style.color = '#22c55e';
        } else if (healthScore >= 40) {
          healthScoreEl.style.color = '#fbbf24';
        } else {
          healthScoreEl.style.color = '#ef4444';
        }
        
        portfolioHealthEl.style.display = walletState.address ? 'block' : 'none';
      }
    }

    // Load wallet assets for health score
    async function loadWalletAssetsForHealth() {
      const walletState = window.WalletConnect ? window.WalletConnect.getState() : null;
      if (!walletState || !walletState.provider || !walletState.address) return;

      try {
        userAssets = [];

        // Get ETH balance
        const ethBalance = await walletState.provider.getBalance(walletState.address);
        const ethAmount = parseFloat(ethers.utils.formatEther(ethBalance));
        
        if (ethAmount > 0) {
          userAssets.push({ symbol: 'ETH', balance: ethAmount });
        }

        // Check common tokens
        const tokens = [
          { address: '0xdAC17F958D2ee523a2206206994597C13D831ec7', symbol: 'USDT', decimals: 6 },
          { address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', symbol: 'USDC', decimals: 6 },
          { address: '0x6B175474E89094C44Da98b954EedeAC495271d0F', symbol: 'DAI', decimals: 18 },
        ];

        for (const token of tokens) {
          try {
            const contract = new ethers.Contract(
              token.address,
              ['function balanceOf(address) view returns (uint256)'],
              walletState.provider
            );
            const balance = await contract.balanceOf(walletState.address);
            const amount = parseFloat(ethers.utils.formatUnits(balance, token.decimals));
            if (amount > 0.01) {
              userAssets.push({ symbol: token.symbol, balance: amount });
            }
          } catch (err) {
            console.warn(`Failed to load ${token.symbol}`);
          }
        }

        updatePortfolioHealth();
      } catch (error) {
        console.error('Error loading assets:', error);
      }
    }

    // Listen for wallet state changes
    window.addEventListener('walletStateChanged', (e) => {
      const state = e.detail;
      if (state.status === 'connected') {
        loadWalletAssetsForHealth();
      } else {
        userAssets = [];
        updatePortfolioHealth();
      }
    });
  </script>
</body>
</html>
