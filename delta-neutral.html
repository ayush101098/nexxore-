<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Delta Neutral Builder | Nexxore</title>
  <meta name="description" content="Build delta-neutral positions combining perpetual futures and options. Automated hedging with real-time risk metrics.">
  <meta name="keywords" content="delta neutral, hedging, perpetuals, options, DeFi strategies, market neutral">
  <link rel="canonical" href="https://nexxore.vercel.app/delta-neutral.html">
  
  <!-- Favicons -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' stop-color='%23a855f7'/><stop offset='100%25' stop-color='%2322c55e'/></linearGradient></defs><rect width='32' height='32' rx='6' fill='%2308080a'/><circle cx='12' cy='11' r='6' stroke='url(%23g)' stroke-width='2' fill='none'/><circle cx='20' cy='11' r='6' stroke='url(%23g)' stroke-width='2' fill='none' opacity='.9'/><circle cx='16' cy='18' r='6' stroke='url(%23g)' stroke-width='2' fill='none' opacity='.9'/></svg>" type="image/svg+xml">
  <link rel="icon" type="image/svg+xml" href="frontend/assets/icons/favicon.svg">
  
  <!-- Open Graph -->
  <meta property="og:title" content="Delta Neutral Builder | Nexxore">
  <meta property="og:description" content="Build market-neutral positions with automated hedging across perpetuals and options.">
  <meta property="og:image" content="https://nexxore.vercel.app/frontend/assets/icons/og-image.svg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="theme-color" content="#08080a">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg: #09090b;
      --surface: #0f0f12;
      --surface-2: #16161a;
      --surface-3: #1c1c21;
      --border: rgba(255,255,255,0.06);
      --border-hover: rgba(255,255,255,0.12);
      --text: #fafafa;
      --text-secondary: rgba(255,255,255,0.6);
      --text-tertiary: rgba(255,255,255,0.35);
      --accent: #3b82f6;
      --accent-dim: rgba(59,130,246,0.12);
      --green: #22c55e;
      --green-dim: rgba(34,197,94,0.12);
      --red: #ef4444;
      --red-dim: rgba(239,68,68,0.12);
      --yellow: #eab308;
      --yellow-dim: rgba(234,179,8,0.12);
      --purple: #a855f7;
      --purple-dim: rgba(168,85,247,0.12);
      --cyan: #06b6d4;
      --cyan-dim: rgba(6,182,212,0.12);
      --mono: 'JetBrains Mono', monospace;
      --sans: 'Inter', -apple-system, sans-serif;
      --radius: 10px;
      --radius-lg: 14px;
    }

    body {
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* Layout */
    .app {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 24px 48px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: var(--text);
    }

    .logo-mark {
      width: 34px;
      height: 34px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 15px;
    }

    .logo-text {
      font-weight: 600;
      font-size: 18px;
      letter-spacing: -0.5px;
    }

    .header-center {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--surface-2);
      padding: 4px;
      border-radius: 8px;
    }

    .nav-pill {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.15s;
    }

    .nav-pill:hover { color: var(--text); background: var(--surface-3); }
    .nav-pill.active { color: var(--text); background: var(--surface); }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-secondary);
      padding: 6px 12px;
      background: var(--surface-2);
      border-radius: 20px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--green);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(34,197,94,0.4); }
      50% { opacity: 0.8; box-shadow: 0 0 0 4px rgba(34,197,94,0); }
    }

    /* Page Title */
    .page-header {
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: -0.5px;
      margin-bottom: 6px;
    }

    .page-subtitle {
      color: var(--text-tertiary);
      font-size: 14px;
    }

    /* Main Layout */
    .main-layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 20px;
    }

    @media (max-width: 1200px) {
      .main-layout { grid-template-columns: 1fr; }
    }

    /* Strategy Cards with Graphs */
    .strategy-section {
      margin-bottom: 20px;
    }

    .section-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-tertiary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .strategy-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .strategy-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .strategy-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-1px);
    }

    .strategy-card.active {
      border-color: var(--accent);
      background: linear-gradient(135deg, var(--accent-dim), transparent);
    }

    .strategy-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .strategy-card-name {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 2px;
    }

    .strategy-card-desc {
      font-size: 11px;
      color: var(--text-tertiary);
    }

    .strategy-badge {
      font-family: var(--mono);
      font-size: 10px;
      font-weight: 600;
      padding: 3px 6px;
      border-radius: 4px;
    }

    .strategy-badge.neutral { background: var(--green-dim); color: var(--green); }
    .strategy-badge.bullish { background: var(--cyan-dim); color: var(--cyan); }
    .strategy-badge.bearish { background: var(--red-dim); color: var(--red); }

    .strategy-mini-chart {
      height: 50px;
      margin: 8px -14px -14px;
      background: var(--surface-2);
      border-top: 1px solid var(--border);
      position: relative;
    }

    .strategy-mini-chart canvas {
      width: 100%;
      height: 100%;
    }

    .strategy-stats {
      display: flex;
      gap: 12px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }

    .strategy-stat {
      font-size: 10px;
    }

    .strategy-stat-label {
      color: var(--text-tertiary);
      margin-bottom: 2px;
    }

    .strategy-stat-value {
      font-family: var(--mono);
      font-weight: 600;
      font-size: 11px;
    }

    /* Asset Selector */
    .asset-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .asset-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.15s;
    }

    .asset-btn:hover { border-color: var(--border-hover); }
    
    .asset-btn.active {
      border-color: var(--accent);
      background: var(--accent-dim);
    }

    .asset-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 10px;
    }

    .asset-icon.eth { background: linear-gradient(135deg, #627eea, #8c9eff); }
    .asset-icon.btc { background: linear-gradient(135deg, #f7931a, #ffb84d); }
    .asset-icon.sol { background: linear-gradient(135deg, #9945ff, #14f195); }

    .asset-info {
      text-align: left;
    }

    .asset-symbol {
      font-weight: 600;
      font-size: 14px;
    }

    .asset-price {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* Panel */
    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .panel-header {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--surface-2);
    }

    .panel-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }

    .panel-badge {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-tertiary);
    }

    .panel-body {
      padding: 18px;
    }

    /* Settings Panel */
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .setting-item {
      background: var(--surface-2);
      border-radius: 8px;
      padding: 12px;
    }

    .setting-label {
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .setting-value {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--accent);
    }

    .slider-container {
      position: relative;
    }

    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 4px;
      border-radius: 2px;
      background: var(--surface-3);
      outline: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(59,130,246,0.4);
    }

    /* Right Column */
    .right-column {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Live Chart */
    .chart-panel {
      flex: 1;
      min-height: 320px;
    }

    .chart-container {
      height: 280px;
      background: var(--bg);
      border-radius: 8px;
    }

    .chart-toolbar {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
    }

    .chart-tf-btn {
      padding: 5px 10px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 5px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }

    .chart-tf-btn:hover { border-color: var(--border-hover); color: var(--text); }
    .chart-tf-btn.active { background: var(--accent); border-color: var(--accent); color: white; }

    /* Builder Panel */
    .builder-tabs {
      display: flex;
      gap: 2px;
      background: var(--bg);
      padding: 3px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .builder-tab {
      flex: 1;
      padding: 10px;
      background: transparent;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-tertiary);
      cursor: pointer;
      transition: all 0.15s;
    }

    .builder-tab:hover { color: var(--text-secondary); }
    .builder-tab.active { background: var(--surface-2); color: var(--text); }

    /* Position Rows */
    .leg-builder {
      margin-bottom: 16px;
    }

    .leg-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .leg-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
    }

    .add-btn {
      font-size: 11px;
      color: var(--accent);
      background: var(--accent-dim);
      border: none;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.15s;
    }

    .add-btn:hover { background: var(--accent); color: white; }

    .leg-row {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 10px 12px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    /* Toggle Group */
    .toggle-group {
      display: flex;
      background: var(--bg);
      border-radius: 6px;
      padding: 2px;
    }

    .toggle-btn {
      padding: 6px 12px;
      background: none;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-tertiary);
      cursor: pointer;
      transition: all 0.15s;
    }

    .toggle-btn.active { background: var(--surface); color: var(--text); }
    .toggle-btn.long.active { color: var(--green); background: var(--green-dim); }
    .toggle-btn.short.active { color: var(--red); background: var(--red-dim); }
    .toggle-btn.call.active { color: var(--green); background: var(--green-dim); }
    .toggle-btn.put.active { color: var(--red); background: var(--red-dim); }

    /* Input */
    .input {
      width: 100%;
      padding: 8px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: var(--mono);
      font-size: 13px;
      color: var(--text);
      transition: border-color 0.15s;
    }

    .input:focus { outline: none; border-color: var(--accent); }
    .input::placeholder { color: var(--text-tertiary); }

    .input-sm {
      width: 70px;
      padding: 6px 8px;
      font-size: 12px;
    }

    /* Remove Button */
    .remove-btn {
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 14px;
      transition: all 0.15s;
    }

    .remove-btn:hover {
      border-color: var(--red);
      color: var(--red);
      background: var(--red-dim);
    }

    /* Expiry Row */
    .expiry-row {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }

    .expiry-btn {
      flex: 1;
      padding: 8px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }

    .expiry-btn:hover { border-color: var(--border-hover); }
    .expiry-btn.active { border-color: var(--purple); color: var(--purple); background: var(--purple-dim); }

    /* Greeks Display */
    .greeks-bar {
      display: flex;
      gap: 1px;
      background: var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .greek-cell {
      flex: 1;
      background: var(--surface-2);
      padding: 12px 8px;
      text-align: center;
    }

    .greek-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
      margin-bottom: 4px;
    }

    .greek-val {
      font-family: var(--mono);
      font-size: 14px;
      font-weight: 600;
    }

    .greek-val.pos { color: var(--green); }
    .greek-val.neg { color: var(--red); }
    .greek-val.neu { color: var(--yellow); }

    /* Delta Gauge */
    .delta-gauge {
      margin-bottom: 16px;
    }

    .gauge-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .gauge-label {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .gauge-value {
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 600;
    }

    .gauge-track {
      height: 8px;
      background: linear-gradient(90deg, var(--red) 0%, var(--yellow) 50%, var(--green) 100%);
      border-radius: 4px;
      position: relative;
    }

    .gauge-thumb {
      position: absolute;
      top: -4px;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      transform: translateX(-50%);
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      transition: left 0.3s ease;
    }

    .gauge-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 9px;
      color: var(--text-tertiary);
    }

    /* P&L Chart */
    .pnl-section {
      margin-top: 16px;
    }

    .pnl-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .pnl-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
    }

    .pnl-stats {
      display: flex;
      gap: 16px;
    }

    .pnl-stat {
      text-align: right;
    }

    .pnl-stat-label {
      font-size: 9px;
      color: var(--text-tertiary);
      text-transform: uppercase;
    }

    .pnl-stat-value {
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 600;
    }

    .pnl-stat-value.profit { color: var(--green); }
    .pnl-stat-value.loss { color: var(--red); }
    .pnl-stat-value.be { color: var(--yellow); }

    #pnlChart {
      width: 100%;
      height: 180px;
      background: var(--bg);
      border-radius: 8px;
    }

    /* Summary Cards */
    .summary-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 16px;
    }

    .summary-card {
      background: var(--surface-2);
      border-radius: 8px;
      padding: 14px;
      text-align: center;
    }

    .summary-card-label {
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 6px;
    }

    .summary-card-value {
      font-family: var(--mono);
      font-size: 16px;
      font-weight: 600;
    }

    .summary-card-value.green { color: var(--green); }
    .summary-card-value.red { color: var(--red); }

    /* Action Bar */
    .action-bar {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .btn {
      flex: 1;
      padding: 14px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--green);
      color: white;
    }

    .btn-primary:hover {
      background: #16a34a;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(34,197,94,0.3);
    }

    .btn-secondary {
      background: var(--surface-2);
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      border-color: var(--border-hover);
      background: var(--surface-3);
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-hover); border-radius: 3px; }

    /* Responsive */
    @media (max-width: 768px) {
      .app { padding: 0 16px 32px; }
      .strategy-grid { grid-template-columns: 1fr; }
      .settings-grid { grid-template-columns: 1fr; }
      .summary-row { grid-template-columns: 1fr 1fr; }
      .greeks-bar { flex-wrap: wrap; }
      .greek-cell { min-width: 60px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <a href="/" class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" style="width: 28px; height: 28px;">
          <defs><linearGradient id="logoGrad" x1="0" x2="1"><stop offset="0" stop-color="#a855f7"/><stop offset="1" stop-color="#22c55e"/></linearGradient></defs>
          <g transform="translate(10,15) scale(0.8)"><circle cx="50" cy="40" r="28" stroke="url(#logoGrad)" stroke-width="6" fill="none" opacity="0.95"/><circle cx="78" cy="40" r="28" stroke="url(#logoGrad)" stroke-width="6" fill="none" opacity="0.85"/><circle cx="64" cy="64" r="28" stroke="url(#logoGrad)" stroke-width="6" fill="none" opacity="0.85"/></g>
        </svg>
        <span class="logo-text">nexxore</span>
      </a>
      <div class="header-center">
        <a href="/perps.html" class="nav-pill">Perpetuals</a>
        <a href="/delta-neutral.html" class="nav-pill active">Builder</a>
        <a href="/delta-agent.html" class="nav-pill">Agent</a>
        <a href="/vaults.html" class="nav-pill">Vaults</a>
      </div>
      <div class="header-right">
        <div class="status-badge">
          <span class="status-dot"></span>
          <span>Live Prices</span>
        </div>
      </div>
    </header>

    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">Delta Neutral Builder</h1>
      <p class="page-subtitle">Combine perpetuals and options to create market-neutral positions with defined risk profiles.</p>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
      <!-- Left Column: Strategies & Settings -->
      <div>
        <!-- Asset Selector -->
        <div class="asset-bar">
          <div class="asset-btn active" data-asset="ETH">
            <div class="asset-icon eth">Îž</div>
            <div class="asset-info">
              <div class="asset-symbol">ETH</div>
              <div class="asset-price" id="ethPrice">â€”</div>
            </div>
          </div>
          <div class="asset-btn" data-asset="BTC">
            <div class="asset-icon btc">â‚¿</div>
            <div class="asset-info">
              <div class="asset-symbol">BTC</div>
              <div class="asset-price" id="btcPrice">â€”</div>
            </div>
          </div>
          <div class="asset-btn" data-asset="SOL">
            <div class="asset-icon sol">â—Ž</div>
            <div class="asset-info">
              <div class="asset-symbol">SOL</div>
              <div class="asset-price" id="solPrice">â€”</div>
            </div>
          </div>
        </div>

        <!-- Strategy Cards -->
        <div class="strategy-section">
          <div class="section-label">Strategy Templates</div>
          <div class="strategy-grid">
            <div class="strategy-card active" data-strategy="delta-neutral">
              <div class="strategy-card-header">
                <div>
                  <div class="strategy-card-name">Delta Neutral</div>
                  <div class="strategy-card-desc">Long perp + protective puts</div>
                </div>
                <span class="strategy-badge neutral">Î”â‰ˆ0</span>
              </div>
              <div class="strategy-stats">
                <div class="strategy-stat">
                  <div class="strategy-stat-label">Risk</div>
                  <div class="strategy-stat-value" style="color: var(--green);">Low</div>
                </div>
                <div class="strategy-stat">
                  <div class="strategy-stat-label">Reward</div>
                  <div class="strategy-stat-value">Medium</div>
                </div>
              </div>
              <div class="strategy-mini-chart">
                <canvas id="strategyChart1"></canvas>
              </div>
            </div>

            <div class="strategy-card" data-strategy="covered-call">
              <div class="strategy-card-header">
                <div>
                  <div class="strategy-card-name">Covered Call</div>
                  <div class="strategy-card-desc">Long perp + sell OTM call</div>
                </div>
                <span class="strategy-badge bullish">Î”â‰ˆ0.3</span>
              </div>
              <div class="strategy-stats">
                <div class="strategy-stat">
                  <div class="strategy-stat-label">Risk</div>
                  <div class="strategy-stat-value" style="color: var(--yellow);">Med</div>
                </div>
                <div class="strategy-stat">
                  <div class="strategy-stat-label">Yield</div>
                  <div class="strategy-stat-value" style="color: var(--green);">+APY</div>
                </div>
              </div>
              <div class="strategy-mini-chart">
                <canvas id="strategyChart2"></canvas>
              </div>
            </div>

            <div class="strategy-card" data-strategy="protective-put">
              <div class="strategy-card-header">
                <div>
                  <div class="strategy-card-name">Protective Put</div>
                  <div class="strategy-card-desc">Long perp + buy OTM put</div>
                </div>
                <span class="strategy-badge bullish">Î”â‰ˆ0.5</span>
              </div>
              <div class="strategy-stats">
                <div class="strategy-stat">
                  <div class="strategy-stat-label">Risk</div>
                  <div class="strategy-stat-value" style="color: var(--green);">Capped</div>
                </div>
                <div class="strategy-stat">
                  <div class="strategy-stat-label">Cost</div>
                  <div class="strategy-stat-value" style="color: var(--red);">Premium</div>
                </div>
              </div>
              <div class="strategy-mini-chart">
                <canvas id="strategyChart3"></canvas>
              </div>
            </div>

            <div class="strategy-card" data-strategy="straddle">
              <div class="strategy-card-header">
                <div>
                  <div class="strategy-card-name">Hedged Straddle</div>
                  <div class="strategy-card-desc">Straddle + short perp</div>
                </div>
                <span class="strategy-badge neutral">Î”â‰ˆ0</span>
              </div>
              <div class="strategy-stats">
                <div class="strategy-stat">
                  <div class="strategy-stat-label">Volatility</div>
                  <div class="strategy-stat-value" style="color: var(--purple);">Long</div>
                </div>
                <div class="strategy-stat">
                  <div class="strategy-stat-label">Theta</div>
                  <div class="strategy-stat-value" style="color: var(--red);">-</div>
                </div>
              </div>
              <div class="strategy-mini-chart">
                <canvas id="strategyChart4"></canvas>
              </div>
            </div>

            <div class="strategy-card" data-strategy="iron-condor">
              <div class="strategy-card-header">
                <div>
                  <div class="strategy-card-name">Iron Condor</div>
                  <div class="strategy-card-desc">Range-bound income</div>
                </div>
                <span class="strategy-badge neutral">Î”â‰ˆ0</span>
              </div>
              <div class="strategy-stats">
                <div class="strategy-stat">
                  <div class="strategy-stat-label">Win Rate</div>
                  <div class="strategy-stat-value" style="color: var(--green);">High</div>
                </div>
                <div class="strategy-stat">
                  <div class="strategy-stat-label">Risk</div>
                  <div class="strategy-stat-value" style="color: var(--yellow);">Defined</div>
                </div>
              </div>
              <div class="strategy-mini-chart">
                <canvas id="strategyChart5"></canvas>
              </div>
            </div>

            <div class="strategy-card" data-strategy="custom">
              <div class="strategy-card-header">
                <div>
                  <div class="strategy-card-name">Custom Build</div>
                  <div class="strategy-card-desc">Design your own strategy</div>
                </div>
                <span class="strategy-badge" style="background: var(--purple-dim); color: var(--purple);">PRO</span>
              </div>
              <div class="strategy-stats">
                <div class="strategy-stat">
                  <div class="strategy-stat-label">Flexibility</div>
                  <div class="strategy-stat-value" style="color: var(--purple);">Full</div>
                </div>
                <div class="strategy-stat">
                  <div class="strategy-stat-label">Legs</div>
                  <div class="strategy-stat-value">Unlimited</div>
                </div>
              </div>
              <div class="strategy-mini-chart">
                <canvas id="strategyChart6"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Advanced Settings -->
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">Parameters</span>
            <span class="panel-badge">Advanced</span>
          </div>
          <div class="panel-body">
            <div class="settings-grid">
              <div class="setting-item">
                <div class="setting-label">
                  <span>Implied Volatility</span>
                  <span class="setting-value" id="ivDisplay">60%</span>
                </div>
                <input type="range" class="slider" id="ivSlider" min="20" max="150" value="60">
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Risk-Free Rate</span>
                  <span class="setting-value" id="rateDisplay">5%</span>
                </div>
                <input type="range" class="slider" id="rateSlider" min="0" max="15" value="5">
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Max Leverage</span>
                  <span class="setting-value" id="levDisplay">10x</span>
                </div>
                <input type="range" class="slider" id="levSlider" min="1" max="50" value="10">
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Slippage Tolerance</span>
                  <span class="setting-value" id="slipDisplay">0.5%</span>
                </div>
                <input type="range" class="slider" id="slipSlider" min="1" max="30" value="5">
              </div>
            </div>
            
            <div class="section-label" style="margin-top: 16px;">Expiry Selection</div>
            <div class="expiry-row">
              <button class="expiry-btn active" data-expiry="7">7D</button>
              <button class="expiry-btn" data-expiry="14">14D</button>
              <button class="expiry-btn" data-expiry="30">30D</button>
              <button class="expiry-btn" data-expiry="60">60D</button>
              <button class="expiry-btn" data-expiry="90">90D</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Chart & Builder -->
      <div class="right-column">
        <!-- Price Chart -->
        <div class="panel chart-panel">
          <div class="panel-header">
            <span class="panel-title" id="chartTitle">ETH-USD â€¢ Live</span>
            <span id="spotPrice" style="font-family: var(--mono); font-size: 14px; font-weight: 600;">$0.00</span>
          </div>
          <div class="panel-body">
            <div class="chart-toolbar">
              <button class="chart-tf-btn" data-tf="1m">1M</button>
              <button class="chart-tf-btn" data-tf="5m">5M</button>
              <button class="chart-tf-btn active" data-tf="15m">15M</button>
              <button class="chart-tf-btn" data-tf="1h">1H</button>
              <button class="chart-tf-btn" data-tf="4h">4H</button>
              <button class="chart-tf-btn" data-tf="1d">1D</button>
            </div>
            <div class="chart-container" id="priceChart"></div>
          </div>
        </div>

        <!-- Position Builder -->
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">Position Builder</span>
            <span class="panel-badge" id="totalLegs">0 legs</span>
          </div>
          <div class="panel-body">
            <!-- Builder Tabs -->
            <div class="builder-tabs">
              <button class="builder-tab active" data-tab="combined">Combined View</button>
              <button class="builder-tab" data-tab="perps">Perpetuals</button>
              <button class="builder-tab" data-tab="options">Options</button>
            </div>

            <!-- Perpetuals -->
            <div class="leg-builder" id="perpSection">
              <div class="leg-header">
                <span class="leg-title">âš¡ Perpetual Futures</span>
                <button class="add-btn" id="addPerpBtn">+ Add Perp</button>
              </div>
              <div id="perpContainer">
                <div class="leg-row" data-perp-id="1">
                  <div class="toggle-group">
                    <button class="toggle-btn long active">Long</button>
                    <button class="toggle-btn short">Short</button>
                  </div>
                  <input type="number" class="input" style="flex:1;" placeholder="Size (USD)" value="10000">
                  <input type="number" class="input input-sm" placeholder="Lev" value="1" min="1">
                  <button class="remove-btn" onclick="removeLeg(this)">Ã—</button>
                </div>
              </div>
            </div>

            <!-- Options -->
            <div class="leg-builder" id="optionSection">
              <div class="leg-header">
                <span class="leg-title">ðŸ“Š Options</span>
                <button class="add-btn" id="addOptionBtn">+ Add Option</button>
              </div>
              <div id="optionContainer">
                <div class="leg-row" data-option-id="1">
                  <div class="toggle-group">
                    <button class="toggle-btn call active">Call</button>
                    <button class="toggle-btn put">Put</button>
                  </div>
                  <input type="number" class="input" style="width: 90px;" placeholder="Strike">
                  <input type="number" class="input input-sm" placeholder="Qty" value="1">
                  <div class="toggle-group">
                    <button class="toggle-btn long active">Buy</button>
                    <button class="toggle-btn short">Sell</button>
                  </div>
                  <button class="remove-btn" onclick="removeLeg(this)">Ã—</button>
                </div>
              </div>
            </div>

            <!-- Greeks Bar -->
            <div class="greeks-bar">
              <div class="greek-cell">
                <div class="greek-label">Delta</div>
                <div class="greek-val neu" id="gDelta">0.00</div>
              </div>
              <div class="greek-cell">
                <div class="greek-label">Gamma</div>
                <div class="greek-val" id="gGamma">0.00</div>
              </div>
              <div class="greek-cell">
                <div class="greek-label">Theta</div>
                <div class="greek-val" id="gTheta">0.00</div>
              </div>
              <div class="greek-cell">
                <div class="greek-label">Vega</div>
                <div class="greek-val" id="gVega">0.00</div>
              </div>
              <div class="greek-cell">
                <div class="greek-label">IV</div>
                <div class="greek-val" id="gIV">60%</div>
              </div>
            </div>

            <!-- Delta Gauge -->
            <div class="delta-gauge">
              <div class="gauge-header">
                <span class="gauge-label">Net Delta Exposure</span>
                <span class="gauge-value" id="deltaStatus">Neutral</span>
              </div>
              <div class="gauge-track">
                <div class="gauge-thumb" id="deltaThumb" style="left: 50%;"></div>
              </div>
              <div class="gauge-labels">
                <span>Bearish (-10)</span>
                <span>Neutral (0)</span>
                <span>Bullish (+10)</span>
              </div>
            </div>

            <!-- P&L Section -->
            <div class="pnl-section">
              <div class="pnl-header">
                <span class="pnl-title">P&L at Expiry</span>
                <div class="pnl-stats">
                  <div class="pnl-stat">
                    <div class="pnl-stat-label">Max Profit</div>
                    <div class="pnl-stat-value profit" id="maxProfit">âˆž</div>
                  </div>
                  <div class="pnl-stat">
                    <div class="pnl-stat-label">Max Loss</div>
                    <div class="pnl-stat-value loss" id="maxLoss">$0</div>
                  </div>
                  <div class="pnl-stat">
                    <div class="pnl-stat-label">Breakeven</div>
                    <div class="pnl-stat-value be" id="breakeven">â€”</div>
                  </div>
                </div>
              </div>
              <canvas id="pnlChart"></canvas>
            </div>

            <!-- Summary -->
            <div class="summary-row">
              <div class="summary-card">
                <div class="summary-card-label">Collateral</div>
                <div class="summary-card-value" id="totalCollateral">$0</div>
              </div>
              <div class="summary-card">
                <div class="summary-card-label">Net Premium</div>
                <div class="summary-card-value" id="netPremium">$0</div>
              </div>
              <div class="summary-card">
                <div class="summary-card-label">Funding</div>
                <div class="summary-card-value green" id="funding">+0.01%</div>
              </div>
              <div class="summary-card">
                <div class="summary-card-label">Est. APY</div>
                <div class="summary-card-value green" id="estApy">â€”</div>
              </div>
            </div>

            <!-- Actions -->
            <div class="action-bar">
              <button class="btn btn-secondary" id="simulateBtn">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v12l4-3 4 3 4-3V3l-4 3-4-3-4 3z"/></svg>
                Simulate
              </button>
              <button class="btn btn-primary" id="executeBtn">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12l5-5-5-5"/><path d="M11 12l5-5-5-5"/></svg>
                Execute Position
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================================
    // STATE
    // ============================================================================
    const state = {
      asset: 'ETH',
      spotPrice: 0,
      prices: { ETH: 0, BTC: 0, SOL: 0 },
      expiry: 7,
      iv: 0.60,
      riskFreeRate: 0.05,
      maxLeverage: 10,
      slippage: 0.005,
      timeframe: '15m',
      perpIdCounter: 1,
      optionIdCounter: 1
    };

    const SYMBOLS = { ETH: 'ETHUSDT', BTC: 'BTCUSDT', SOL: 'SOLUSDT' };
    const TF_MAP = { '1m': '1m', '5m': '5m', '15m': '15m', '1h': '1h', '4h': '4h', '1d': '1d' };
    let chart = null, candleSeries = null, ws = null;

    // ============================================================================
    // PRICE FETCHING
    // ============================================================================
    async function fetchPrices() {
      try {
        const results = await Promise.all(
          Object.entries(SYMBOLS).map(async ([asset, symbol]) => {
            const res = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`);
            return { asset, data: await res.json() };
          })
        );
        
        results.forEach(({ asset, data }) => {
          state.prices[asset] = parseFloat(data.lastPrice);
          const priceEl = document.getElementById(`${asset.toLowerCase()}Price`);
          if (priceEl) {
            priceEl.textContent = `$${state.prices[asset].toLocaleString(undefined, { maximumFractionDigits: asset === 'BTC' ? 0 : 2 })}`;
          }
          
          if (asset === state.asset) {
            state.spotPrice = state.prices[asset];
            document.getElementById('spotPrice').textContent = 
              `$${state.spotPrice.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
            setDefaultStrikes();
          }
        });
        
        calculate();
      } catch (e) { console.error('Price fetch error:', e); }
    }

    function setDefaultStrikes() {
      document.querySelectorAll('#optionContainer .leg-row input[placeholder="Strike"]').forEach(input => {
        if (!input.value && state.spotPrice > 0) {
          input.value = Math.round(state.spotPrice / 50) * 50;
        }
      });
    }

    // ============================================================================
    // LIVE CHART
    // ============================================================================
    function initChart() {
      const container = document.getElementById('priceChart');
      chart = LightweightCharts.createChart(container, {
        layout: { background: { type: 'solid', color: '#09090b' }, textColor: 'rgba(255,255,255,0.5)' },
        grid: { vertLines: { color: 'rgba(255,255,255,0.03)' }, horzLines: { color: 'rgba(255,255,255,0.03)' } },
        rightPriceScale: { borderVisible: false },
        timeScale: { borderVisible: false, timeVisible: true },
        crosshair: { vertLine: { color: 'rgba(59,130,246,0.3)' }, horzLine: { color: 'rgba(59,130,246,0.3)' } }
      });

      candleSeries = chart.addCandlestickSeries({
        upColor: '#22c55e', downColor: '#ef4444',
        borderUpColor: '#22c55e', borderDownColor: '#ef4444',
        wickUpColor: '#22c55e', wickDownColor: '#ef4444'
      });

      loadChartData();
    }

    async function loadChartData() {
      try {
        const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${SYMBOLS[state.asset]}&interval=${state.timeframe}&limit=200`);
        const data = await res.json();
        candleSeries.setData(data.map(d => ({
          time: d[0] / 1000, open: +d[1], high: +d[2], low: +d[3], close: +d[4]
        })));
        connectWS();
      } catch (e) { console.error('Chart error:', e); }
    }

    function connectWS() {
      if (ws) ws.close();
      ws = new WebSocket(`wss://stream.binance.com:9443/ws/${SYMBOLS[state.asset].toLowerCase()}@kline_${state.timeframe}`);
      ws.onmessage = e => {
        const k = JSON.parse(e.data).k;
        candleSeries.update({ time: k.t / 1000, open: +k.o, high: +k.h, low: +k.l, close: +k.c });
        state.spotPrice = +k.c;
        state.prices[state.asset] = state.spotPrice;
        document.getElementById('spotPrice').textContent = `$${state.spotPrice.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
      };
    }

    // ============================================================================
    // BLACK-SCHOLES
    // ============================================================================
    function normalCDF(x) {
      const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741, a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
      const sign = x < 0 ? -1 : 1;
      x = Math.abs(x) / Math.sqrt(2);
      const t = 1 / (1 + p * x);
      const y = 1 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
      return 0.5 * (1 + sign * y);
    }

    function normalPDF(x) { return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI); }

    function bsGreeks(S, K, T, r, sigma, isCall) {
      if (T <= 0 || sigma <= 0) return { price: 0, delta: 0, gamma: 0, theta: 0, vega: 0 };
      const d1 = (Math.log(S / K) + (r + sigma * sigma / 2) * T) / (sigma * Math.sqrt(T));
      const d2 = d1 - sigma * Math.sqrt(T);
      const Nd1 = normalCDF(d1), Nd2 = normalCDF(d2), nd1 = normalPDF(d1);
      
      let price, delta;
      if (isCall) {
        price = S * Nd1 - K * Math.exp(-r * T) * Nd2;
        delta = Nd1;
      } else {
        price = K * Math.exp(-r * T) * normalCDF(-d2) - S * normalCDF(-d1);
        delta = Nd1 - 1;
      }
      
      return {
        price,
        delta,
        gamma: nd1 / (S * sigma * Math.sqrt(T)),
        theta: (-S * nd1 * sigma / (2 * Math.sqrt(T)) - r * K * Math.exp(-r * T) * (isCall ? Nd2 : normalCDF(-d2))) / 365,
        vega: S * nd1 * Math.sqrt(T) / 100
      };
    }

    // ============================================================================
    // CALCULATIONS
    // ============================================================================
    function calculate() {
      if (state.spotPrice <= 0) return;
      
      let totalDelta = 0, totalGamma = 0, totalTheta = 0, totalVega = 0;
      let totalCollateral = 0, netPremium = 0;
      let legCount = 0;

      // Perps
      document.querySelectorAll('#perpContainer .leg-row').forEach(row => {
        const isLong = row.querySelector('.toggle-btn.long').classList.contains('active');
        const sizeInput = row.querySelectorAll('input')[0];
        const levInput = row.querySelectorAll('input')[1];
        const size = parseFloat(sizeInput?.value) || 0;
        const leverage = Math.min(parseFloat(levInput?.value) || 1, state.maxLeverage);
        
        if (size > 0) {
          const notional = size * leverage;
          const perpDelta = isLong ? notional / state.spotPrice : -notional / state.spotPrice;
          totalDelta += perpDelta;
          totalCollateral += size;
          legCount++;
        }
      });

      // Options
      const T = state.expiry / 365;
      document.querySelectorAll('#optionContainer .leg-row').forEach(row => {
        const toggleGroups = row.querySelectorAll('.toggle-group');
        const isCall = toggleGroups[0]?.querySelector('.toggle-btn.call')?.classList.contains('active');
        const isBuy = toggleGroups[1]?.querySelector('.toggle-btn.long')?.classList.contains('active');
        const inputs = row.querySelectorAll('input');
        const strike = parseFloat(inputs[0]?.value) || state.spotPrice;
        const qty = parseFloat(inputs[1]?.value) || 1;
        
        const greeks = bsGreeks(state.spotPrice, strike, T, state.riskFreeRate, state.iv, isCall);
        const mult = isBuy ? qty : -qty;
        
        totalDelta += greeks.delta * mult;
        totalGamma += greeks.gamma * mult;
        totalTheta += greeks.theta * mult;
        totalVega += greeks.vega * mult;
        
        const premium = greeks.price * qty;
        netPremium += isBuy ? -premium : premium;
        totalCollateral += isBuy ? premium : premium * 2;
        legCount++;
      });

      // Update UI
      document.getElementById('totalLegs').textContent = `${legCount} leg${legCount !== 1 ? 's' : ''}`;
      
      updateGreek('gDelta', totalDelta);
      updateGreek('gGamma', totalGamma);
      updateGreek('gTheta', totalTheta);
      updateGreek('gVega', totalVega);
      document.getElementById('gIV').textContent = `${Math.round(state.iv * 100)}%`;
      
      // Delta gauge
      const exposure = Math.max(-10, Math.min(10, totalDelta));
      const pct = 50 + (exposure / 10) * 50;
      document.getElementById('deltaThumb').style.left = `${pct}%`;
      const statusEl = document.getElementById('deltaStatus');
      if (Math.abs(totalDelta) < 0.1) {
        statusEl.textContent = 'Neutral';
        statusEl.style.color = 'var(--yellow)';
      } else {
        statusEl.textContent = totalDelta > 0 ? 'Bullish' : 'Bearish';
        statusEl.style.color = totalDelta > 0 ? 'var(--green)' : 'var(--red)';
      }

      // Summary
      document.getElementById('totalCollateral').textContent = `$${totalCollateral.toLocaleString(undefined, { minimumFractionDigits: 0 })}`;
      const premiumEl = document.getElementById('netPremium');
      premiumEl.textContent = `${netPremium >= 0 ? '+' : ''}$${netPremium.toLocaleString(undefined, { minimumFractionDigits: 0 })}`;
      premiumEl.classList.toggle('green', netPremium >= 0);
      premiumEl.classList.toggle('red', netPremium < 0);

      // Estimated APY (simplified)
      if (totalCollateral > 0 && netPremium > 0) {
        const annualizedPremium = (netPremium / T) * (365 / state.expiry);
        const apy = (annualizedPremium / totalCollateral) * 100;
        document.getElementById('estApy').textContent = `${apy.toFixed(1)}%`;
      } else {
        document.getElementById('estApy').textContent = 'â€”';
      }

      drawPnLChart();
    }

    function updateGreek(id, value) {
      const el = document.getElementById(id);
      el.textContent = Math.abs(value) < 0.01 ? '0.00' : value.toFixed(3);
      el.className = 'greek-val ' + (Math.abs(value) < 0.05 ? 'neu' : value > 0 ? 'pos' : 'neg');
    }

    // ============================================================================
    // P&L CHART
    // ============================================================================
    function drawPnLChart() {
      const canvas = document.getElementById('pnlChart');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.parentElement.clientWidth;
      canvas.height = 180;
      
      const W = canvas.width, H = canvas.height, P = 35;
      ctx.fillStyle = '#09090b';
      ctx.fillRect(0, 0, W, H);
      
      if (state.spotPrice <= 0) return;

      const minPrice = state.spotPrice * 0.7, maxPrice = state.spotPrice * 1.3;
      const points = [];
      let maxPnL = -Infinity, minPnL = Infinity;

      for (let i = 0; i <= 100; i++) {
        const price = minPrice + ((maxPrice - minPrice) * i / 100);
        const pnl = calcPnLAt(price);
        points.push({ price, pnl });
        maxPnL = Math.max(maxPnL, pnl);
        minPnL = Math.min(minPnL, pnl);
      }

      maxPnL = Math.max(maxPnL, Math.abs(minPnL) * 0.3, 100);
      minPnL = Math.min(minPnL, -Math.abs(maxPnL) * 0.3, -100);
      const range = maxPnL - minPnL || 1;
      const zeroY = P + (maxPnL / range) * (H - 2 * P);

      // Grid
      ctx.strokeStyle = 'rgba(255,255,255,0.05)';
      ctx.setLineDash([]);
      for (let i = 0; i <= 4; i++) {
        const y = P + (i / 4) * (H - 2 * P);
        ctx.beginPath();
        ctx.moveTo(P, y);
        ctx.lineTo(W - P, y);
        ctx.stroke();
      }

      // Zero line
      ctx.strokeStyle = 'rgba(255,255,255,0.15)';
      ctx.setLineDash([4, 4]);
      ctx.beginPath();
      ctx.moveTo(P, zeroY);
      ctx.lineTo(W - P, zeroY);
      ctx.stroke();
      ctx.setLineDash([]);

      // Current price line
      const curX = P + ((state.spotPrice - minPrice) / (maxPrice - minPrice)) * (W - 2 * P);
      ctx.strokeStyle = 'rgba(59,130,246,0.5)';
      ctx.setLineDash([4, 4]);
      ctx.beginPath();
      ctx.moveTo(curX, P);
      ctx.lineTo(curX, H - P);
      ctx.stroke();
      ctx.setLineDash([]);

      // P&L curve
      ctx.beginPath();
      points.forEach((p, i) => {
        const x = P + (i / 100) * (W - 2 * P);
        const y = P + ((maxPnL - p.pnl) / range) * (H - 2 * P);
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      });
      
      ctx.strokeStyle = '#a855f7';
      ctx.lineWidth = 2.5;
      ctx.stroke();

      // Gradient fill
      const gradient = ctx.createLinearGradient(0, P, 0, H - P);
      gradient.addColorStop(0, 'rgba(34,197,94,0.25)');
      gradient.addColorStop(0.5, 'rgba(168,85,247,0.05)');
      gradient.addColorStop(1, 'rgba(239,68,68,0.25)');
      
      ctx.lineTo(W - P, zeroY);
      ctx.lineTo(P, zeroY);
      ctx.closePath();
      ctx.fillStyle = gradient;
      ctx.fill();

      // Labels
      ctx.fillStyle = 'rgba(255,255,255,0.4)';
      ctx.font = '10px JetBrains Mono';
      ctx.textAlign = 'center';
      ctx.fillText(`$${minPrice.toFixed(0)}`, P, H - P + 14);
      ctx.fillText(`$${state.spotPrice.toFixed(0)}`, curX, H - P + 14);
      ctx.fillText(`$${maxPrice.toFixed(0)}`, W - P, H - P + 14);

      // Find breakevens and update stats
      let breakevens = [];
      for (let i = 1; i < points.length; i++) {
        if ((points[i-1].pnl < 0 && points[i].pnl >= 0) || (points[i-1].pnl >= 0 && points[i].pnl < 0)) {
          breakevens.push(points[i].price);
        }
      }
      
      document.getElementById('breakeven').textContent = breakevens.length > 0 
        ? `$${breakevens[0].toFixed(0)}${breakevens.length > 1 ? ` / $${breakevens[1].toFixed(0)}` : ''}`
        : 'â€”';
      document.getElementById('maxProfit').textContent = maxPnL > 1e6 ? 'âˆž' : `$${maxPnL.toFixed(0)}`;
      document.getElementById('maxLoss').textContent = `$${Math.abs(minPnL).toFixed(0)}`;
    }

    function calcPnLAt(price) {
      let pnl = 0;

      // Perps
      document.querySelectorAll('#perpContainer .leg-row').forEach(row => {
        const isLong = row.querySelector('.toggle-btn.long').classList.contains('active');
        const inputs = row.querySelectorAll('input');
        const size = parseFloat(inputs[0]?.value) || 0;
        const leverage = Math.min(parseFloat(inputs[1]?.value) || 1, state.maxLeverage);
        const change = (price - state.spotPrice) / state.spotPrice;
        pnl += isLong ? size * leverage * change : -size * leverage * change;
      });

      // Options
      document.querySelectorAll('#optionContainer .leg-row').forEach(row => {
        const toggleGroups = row.querySelectorAll('.toggle-group');
        const isCall = toggleGroups[0]?.querySelector('.toggle-btn.call')?.classList.contains('active');
        const isBuy = toggleGroups[1]?.querySelector('.toggle-btn.long')?.classList.contains('active');
        const inputs = row.querySelectorAll('input');
        const strike = parseFloat(inputs[0]?.value) || state.spotPrice;
        const qty = parseFloat(inputs[1]?.value) || 1;
        const T = state.expiry / 365;
        const premium = bsGreeks(state.spotPrice, strike, T, state.riskFreeRate, state.iv, isCall).price;
        const intrinsic = isCall ? Math.max(0, price - strike) : Math.max(0, strike - price);
        pnl += isBuy ? (intrinsic - premium) * qty : (premium - intrinsic) * qty;
      });

      return pnl;
    }

    // ============================================================================
    // POSITION MANAGEMENT
    // ============================================================================
    function addPerp() {
      state.perpIdCounter++;
      const html = `
        <div class="leg-row" data-perp-id="${state.perpIdCounter}">
          <div class="toggle-group">
            <button class="toggle-btn long active">Long</button>
            <button class="toggle-btn short">Short</button>
          </div>
          <input type="number" class="input" style="flex:1;" placeholder="Size (USD)" value="">
          <input type="number" class="input input-sm" placeholder="Lev" value="1" min="1">
          <button class="remove-btn" onclick="removeLeg(this)">Ã—</button>
        </div>
      `;
      document.getElementById('perpContainer').insertAdjacentHTML('beforeend', html);
      attachListeners();
    }

    function addOption() {
      state.optionIdCounter++;
      const strike = Math.round(state.spotPrice / 50) * 50;
      const html = `
        <div class="leg-row" data-option-id="${state.optionIdCounter}">
          <div class="toggle-group">
            <button class="toggle-btn call active">Call</button>
            <button class="toggle-btn put">Put</button>
          </div>
          <input type="number" class="input" style="width: 90px;" placeholder="Strike" value="${strike}">
          <input type="number" class="input input-sm" placeholder="Qty" value="1">
          <div class="toggle-group">
            <button class="toggle-btn long active">Buy</button>
            <button class="toggle-btn short">Sell</button>
          </div>
          <button class="remove-btn" onclick="removeLeg(this)">Ã—</button>
        </div>
      `;
      document.getElementById('optionContainer').insertAdjacentHTML('beforeend', html);
      attachListeners();
    }

    function removeLeg(btn) {
      btn.closest('.leg-row').remove();
      calculate();
    }

    // ============================================================================
    // STRATEGY PRESETS
    // ============================================================================
    function applyStrategy(strategy) {
      document.getElementById('perpContainer').innerHTML = '';
      document.getElementById('optionContainer').innerHTML = '';
      state.perpIdCounter = 0;
      state.optionIdCounter = 0;

      const atm = Math.round(state.spotPrice / 50) * 50;
      const otmCall = Math.round(state.spotPrice * 1.1 / 50) * 50;
      const otmPut = Math.round(state.spotPrice * 0.9 / 50) * 50;

      switch (strategy) {
        case 'delta-neutral':
          addPerpPreset('long', 10000, 1);
          addOptionPreset('put', 'buy', atm, 3);
          break;
        case 'covered-call':
          addPerpPreset('long', 10000, 1);
          addOptionPreset('call', 'sell', otmCall, 3);
          break;
        case 'protective-put':
          addPerpPreset('long', 10000, 1);
          addOptionPreset('put', 'buy', otmPut, 3);
          break;
        case 'straddle':
          addOptionPreset('call', 'buy', atm, 1);
          addOptionPreset('put', 'buy', atm, 1);
          addPerpPreset('short', 3000, 1);
          break;
        case 'iron-condor':
          addOptionPreset('put', 'sell', otmPut, 1);
          addOptionPreset('put', 'buy', Math.round(state.spotPrice * 0.85 / 50) * 50, 1);
          addOptionPreset('call', 'sell', otmCall, 1);
          addOptionPreset('call', 'buy', Math.round(state.spotPrice * 1.15 / 50) * 50, 1);
          break;
        case 'custom':
          addPerpPreset('long', 0, 1);
          addOptionPreset('call', 'buy', atm, 1);
          break;
      }
      calculate();
    }

    function addPerpPreset(side, size, leverage) {
      state.perpIdCounter++;
      const html = `
        <div class="leg-row" data-perp-id="${state.perpIdCounter}">
          <div class="toggle-group">
            <button class="toggle-btn long ${side === 'long' ? 'active' : ''}">Long</button>
            <button class="toggle-btn short ${side === 'short' ? 'active' : ''}">Short</button>
          </div>
          <input type="number" class="input" style="flex:1;" placeholder="Size (USD)" value="${size}">
          <input type="number" class="input input-sm" placeholder="Lev" value="${leverage}">
          <button class="remove-btn" onclick="removeLeg(this)">Ã—</button>
        </div>
      `;
      document.getElementById('perpContainer').insertAdjacentHTML('beforeend', html);
      attachListeners();
    }

    function addOptionPreset(type, side, strike, qty) {
      state.optionIdCounter++;
      const html = `
        <div class="leg-row" data-option-id="${state.optionIdCounter}">
          <div class="toggle-group">
            <button class="toggle-btn call ${type === 'call' ? 'active' : ''}">Call</button>
            <button class="toggle-btn put ${type === 'put' ? 'active' : ''}">Put</button>
          </div>
          <input type="number" class="input" style="width: 90px;" placeholder="Strike" value="${strike}">
          <input type="number" class="input input-sm" placeholder="Qty" value="${qty}">
          <div class="toggle-group">
            <button class="toggle-btn long ${side === 'buy' ? 'active' : ''}">Buy</button>
            <button class="toggle-btn short ${side === 'sell' ? 'active' : ''}">Sell</button>
          </div>
          <button class="remove-btn" onclick="removeLeg(this)">Ã—</button>
        </div>
      `;
      document.getElementById('optionContainer').insertAdjacentHTML('beforeend', html);
      attachListeners();
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    function attachListeners() {
      document.querySelectorAll('.toggle-group').forEach(group => {
        group.querySelectorAll('.toggle-btn').forEach(btn => {
          btn.onclick = () => {
            group.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            calculate();
          };
        });
      });

      document.querySelectorAll('.input').forEach(input => {
        input.oninput = calculate;
      });
    }

    // ============================================================================
    // INIT
    // ============================================================================
    document.addEventListener('DOMContentLoaded', () => {
      initChart();
      fetchPrices();
      setInterval(fetchPrices, 15000);

      // Asset selection
      document.querySelectorAll('.asset-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('.asset-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.asset = btn.dataset.asset;
          document.getElementById('chartTitle').textContent = `${state.asset}-USD â€¢ Live`;
          loadChartData();
          fetchPrices();
        };
      });

      // Strategy selection
      document.querySelectorAll('.strategy-card').forEach(card => {
        card.onclick = () => {
          document.querySelectorAll('.strategy-card').forEach(c => c.classList.remove('active'));
          card.classList.add('active');
          applyStrategy(card.dataset.strategy);
        };
      });

      // Expiry selection
      document.querySelectorAll('.expiry-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('.expiry-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.expiry = parseInt(btn.dataset.expiry);
          calculate();
        };
      });

      // Timeframe selection
      document.querySelectorAll('.chart-tf-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('.chart-tf-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.timeframe = btn.dataset.tf;
          loadChartData();
        };
      });

      // Settings sliders
      document.getElementById('ivSlider').oninput = (e) => {
        state.iv = parseInt(e.target.value) / 100;
        document.getElementById('ivDisplay').textContent = `${e.target.value}%`;
        calculate();
      };

      document.getElementById('rateSlider').oninput = (e) => {
        state.riskFreeRate = parseInt(e.target.value) / 100;
        document.getElementById('rateDisplay').textContent = `${e.target.value}%`;
        calculate();
      };

      document.getElementById('levSlider').oninput = (e) => {
        state.maxLeverage = parseInt(e.target.value);
        document.getElementById('levDisplay').textContent = `${e.target.value}x`;
      };

      document.getElementById('slipSlider').oninput = (e) => {
        state.slippage = parseInt(e.target.value) / 1000;
        document.getElementById('slipDisplay').textContent = `${(e.target.value / 10).toFixed(1)}%`;
      };

      // Add buttons
      document.getElementById('addPerpBtn').onclick = addPerp;
      document.getElementById('addOptionBtn').onclick = addOption;

      // Action buttons
      document.getElementById('executeBtn').onclick = () => {
        const delta = parseFloat(document.getElementById('gDelta').textContent);
        alert(`Execute Position\n\nNet Delta: ${delta}\nCollateral: ${document.getElementById('totalCollateral').textContent}\nSlippage: ${(state.slippage * 100).toFixed(1)}%\n\n${Math.abs(delta) < 0.1 ? 'âœ… Delta Neutral' : 'âš ï¸ Has directional exposure'}\n\nSmart contract integration coming soon!`);
      };

      document.getElementById('simulateBtn').onclick = () => {
        calculate();
        drawPnLChart();
        drawStrategyCharts();
      };

      // Builder tabs
      document.querySelectorAll('.builder-tab').forEach(tab => {
        tab.onclick = () => {
          document.querySelectorAll('.builder-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          const view = tab.dataset.tab;
          document.getElementById('perpSection').style.display = (view === 'combined' || view === 'perps') ? 'block' : 'none';
          document.getElementById('optionSection').style.display = (view === 'combined' || view === 'options') ? 'block' : 'none';
        };
      });

      attachListeners();
      setTimeout(() => { calculate(); drawPnLChart(); }, 1500);
    });

    window.addEventListener('resize', () => {
      drawPnLChart();
      drawStrategyCharts();
    });

    // ============================================================================
    // STRATEGY MINI CHARTS
    // ============================================================================
    function drawStrategyCharts() {
      const strategies = {
        1: drawDeltaNeutralMini,
        2: drawCoveredCallMini,
        3: drawProtectivePutMini,
        4: drawStraddleMini,
        5: drawIronCondorMini,
        6: drawCustomMini
      };

      for (let i = 1; i <= 6; i++) {
        const canvas = document.getElementById(`strategyChart${i}`);
        if (canvas && strategies[i]) {
          strategies[i](canvas);
        }
      }
    }

    function setupMiniCanvas(canvas) {
      const rect = canvas.parentElement.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = 50;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#16161a';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      return ctx;
    }

    function drawMiniPnL(ctx, W, H, points, color = '#a855f7') {
      const maxY = Math.max(...points.map(p => Math.abs(p)));
      const zeroY = H / 2;
      
      // Zero line
      ctx.strokeStyle = 'rgba(255,255,255,0.1)';
      ctx.setLineDash([2, 2]);
      ctx.beginPath();
      ctx.moveTo(0, zeroY);
      ctx.lineTo(W, zeroY);
      ctx.stroke();
      ctx.setLineDash([]);

      // P&L curve
      ctx.beginPath();
      points.forEach((p, i) => {
        const x = (i / (points.length - 1)) * W;
        const y = zeroY - (p / (maxY || 1)) * (H / 2 - 5);
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      });
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.stroke();

      // Fill gradient
      ctx.lineTo(W, zeroY);
      ctx.lineTo(0, zeroY);
      ctx.closePath();
      const gradient = ctx.createLinearGradient(0, 0, 0, H);
      gradient.addColorStop(0, color + '30');
      gradient.addColorStop(0.5, color + '05');
      gradient.addColorStop(1, color + '30');
      ctx.fillStyle = gradient;
      ctx.fill();
    }

    function drawDeltaNeutralMini(canvas) {
      const ctx = setupMiniCanvas(canvas);
      const points = [];
      for (let i = 0; i <= 50; i++) {
        const x = (i - 25) / 25;
        points.push(Math.abs(x) < 0.3 ? 0.5 : 0.5 - Math.abs(x) * 0.3);
      }
      drawMiniPnL(ctx, canvas.width, canvas.height, points, '#22c55e');
    }

    function drawCoveredCallMini(canvas) {
      const ctx = setupMiniCanvas(canvas);
      const points = [];
      for (let i = 0; i <= 50; i++) {
        const x = (i - 25) / 25;
        if (x < 0.3) points.push(x * 2);
        else points.push(0.6);
      }
      drawMiniPnL(ctx, canvas.width, canvas.height, points, '#06b6d4');
    }

    function drawProtectivePutMini(canvas) {
      const ctx = setupMiniCanvas(canvas);
      const points = [];
      for (let i = 0; i <= 50; i++) {
        const x = (i - 25) / 25;
        if (x < -0.2) points.push(-0.3);
        else points.push(x * 1.5 - 0.1);
      }
      drawMiniPnL(ctx, canvas.width, canvas.height, points, '#06b6d4');
    }

    function drawStraddleMini(canvas) {
      const ctx = setupMiniCanvas(canvas);
      const points = [];
      for (let i = 0; i <= 50; i++) {
        const x = (i - 25) / 25;
        points.push(Math.abs(x) * 1.5 - 0.3);
      }
      drawMiniPnL(ctx, canvas.width, canvas.height, points, '#22c55e');
    }

    function drawIronCondorMini(canvas) {
      const ctx = setupMiniCanvas(canvas);
      const points = [];
      for (let i = 0; i <= 50; i++) {
        const x = (i - 25) / 25;
        if (Math.abs(x) < 0.4) points.push(0.5);
        else if (Math.abs(x) < 0.7) points.push(0.5 - (Math.abs(x) - 0.4) * 2.5);
        else points.push(-0.25);
      }
      drawMiniPnL(ctx, canvas.width, canvas.height, points, '#eab308');
    }

    function drawCustomMini(canvas) {
      const ctx = setupMiniCanvas(canvas);
      const points = [];
      for (let i = 0; i <= 50; i++) {
        const x = (i - 25) / 25;
        points.push(Math.sin(x * 3) * 0.4);
      }
      drawMiniPnL(ctx, canvas.width, canvas.height, points, '#a855f7');
    }

    // Draw strategy charts after DOM ready
    setTimeout(drawStrategyCharts, 500);
  </script>
</body>
</html>
